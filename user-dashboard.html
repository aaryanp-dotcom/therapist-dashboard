<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Book Therapist</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .dashboard-container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px 30px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { color: #667eea; font-size: 24px; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .user-name { color: #555; font-weight: 500; }
        .logout-btn { background: #ff4757; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .logout-btn:hover { background: #ff3838; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { background: white; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; border: 2px solid transparent; }
        .tab:hover { background: #f0f0f0; }
        .tab.active { background: #667eea; color: white; border-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { color: #333; margin-bottom: 20px; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .search-bar { display: flex; gap: 15px; margin-bottom: 20px; }
        .search-bar input, .search-bar select { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .therapist-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .therapist-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 2px solid #eee; transition: all 0.3s; }
        .therapist-card:hover { border-color: #667eea; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2); }
        .therapist-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .therapist-spec { color: #667eea; font-weight: 500; margin-bottom: 8px; }
        .therapist-bio { color: #666; font-size: 14px; margin-bottom: 15px; line-height: 1.5; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; width: 100%; }
        .btn-book { background: #2ecc71; color: white; }
        .btn-book:hover { background: #27ae60; }
        .btn-cancel { background: #e74c3c; color: white; }
        .btn-cancel:hover { background: #c0392b; }
        .bookings-table { width: 100%; border-collapse: collapse; }
        .bookings-table th, .bookings-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .bookings-table th { background: #f8f9fa; color: #333; font-weight: 600; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; }
        .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .time-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; background: white; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 35px; }
        .time-select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .time-select option { padding: 10px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #ccc; color: #333; }
        .btn-secondary:hover { background: #bbb; }
        .no-data { text-align: center; padding: 40px; color: #999; font-style: italic; }
        .loading { text-align: center; padding: 40px; color: #666; }
        @media (max-width: 768px) { .header { flex-direction: column; gap: 15px; } .tabs { flex-wrap: wrap; } .therapist-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üë§ User Dashboard</h1>
            <div class="header-right">
                <span class="user-name" id="userName">Loading...</span>
                <button class="logout-btn" onclick="doLogout()">Logout</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('therapists')">üîç Find Therapists</div>
            <div class="tab" onclick="switchTab('bookings')">üìÖ My Bookings</div>
            <div class="tab" onclick="switchTab('profile')">‚öôÔ∏è My Profile</div>
        </div>

        <div id="therapists" class="tab-content active">
            <div class="section">
                <h2>Available Therapists</h2>
                <div class="search-bar">
                    <input type="text" id="searchName" placeholder="Search by name..." onkeyup="filterTherapists()">
                    <select id="filterSpec" onchange="filterTherapists()">
                        <option value="">All Specializations</option>
                    </select>
                </div>
                <div id="therapistsList" class="therapist-grid">
                    <div class="loading">Loading therapists...</div>
                </div>
            </div>
        </div>

        <div id="bookings" class="tab-content">
            <div class="section">
                <h2>My Bookings</h2>
                <div id="bookingsList">
                    <div class="loading">Loading bookings...</div>
                </div>
            </div>
        </div>

        <div id="profile" class="tab-content">
            <div class="section">
                <h2>My Profile</h2>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="profileName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profileEmail" readonly>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="profilePhone" placeholder="Enter your phone number">
                </div>
                <button class="btn btn-book" onclick="updateProfile()">Update Profile</button>
            </div>
        </div>
    </div>

    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Book Session</div>
            <div class="form-group">
                <label>Therapist</label>
                <input type="text" id="modalTherapistName" readonly>
            </div>
            <div class="form-group">
                <label>Session Date</label>
                <input type="date" id="sessionDate">
            </div>
            <div class="form-group">
                <label>Select Time Slot (1 Hour Session)</label>
                <select id="sessionTimeSlot" class="time-select">
                    <option value="">Choose a time slot</option>
                    <option value="08:00:00|09:00:00">8:00 AM - 9:00 AM (1 hour)</option>
                    <option value="08:30:00|09:30:00">8:30 AM - 9:30 AM (1 hour)</option>
                    <option value="09:00:00|10:00:00">9:00 AM - 10:00 AM (1 hour)</option>
                    <option value="09:30:00|10:30:00">9:30 AM - 10:30 AM (1 hour)</option>
                    <option value="10:00:00|11:00:00">10:00 AM - 11:00 AM (1 hour)</option>
                    <option value="10:30:00|11:30:00">10:30 AM - 11:30 AM (1 hour)</option>
                    <option value="11:00:00|12:00:00">11:00 AM - 12:00 PM (1 hour)</option>
                    <option value="11:30:00|12:30:00">11:30 AM - 12:30 PM (1 hour)</option>
                    <option value="12:00:00|13:00:00">12:00 PM - 1:00 PM (1 hour)</option>
                    <option value="12:30:00|13:30:00">12:30 PM - 1:30 PM (1 hour)</option>
                    <option value="13:00:00|14:00:00">1:00 PM - 2:00 PM (1 hour)</option>
                    <option value="13:30:00|14:30:00">1:30 PM - 2:30 PM (1 hour)</option>
                    <option value="14:00:00|15:00:00">2:00 PM - 3:00 PM (1 hour)</option>
                    <option value="14:30:00|15:30:00">2:30 PM - 3:30 PM (1 hour)</option>
                    <option value="15:00:00|16:00:00">3:00 PM - 4:00 PM (1 hour)</option>
                    <option value="15:30:00|16:30:00">3:30 PM - 4:30 PM (1 hour)</option>
                    <option value="16:00:00|17:00:00">4:00 PM - 5:00 PM (1 hour)</option>
                    <option value="16:30:00|17:30:00">4:30 PM - 5:30 PM (1 hour)</option>
                    <option value="17:00:00|18:00:00">5:00 PM - 6:00 PM (1 hour)</option>
                    <option value="17:30:00|18:30:00">5:30 PM - 6:30 PM (1 hour)</option>
                    <option value="18:00:00|19:00:00">6:00 PM - 7:00 PM (1 hour)</option>
                    <option value="18:30:00|19:30:00">6:30 PM - 7:30 PM (1 hour)</option>
                    <option value="19:00:00|20:00:00">7:00 PM - 8:00 PM (1 hour)</option>
                    <option value="19:30:00|20:30:00">7:30 PM - 8:30 PM (1 hour)</option>
                    <option value="20:00:00|21:00:00">8:00 PM - 9:00 PM (1 hour)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes (Optional)</label>
                <textarea id="sessionNotes" rows="3" placeholder="Any specific concerns or questions..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-modal btn-primary" onclick="confirmBooking()">Book Session</button>
                <button class="btn-modal btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./auth.js"></script>
    <script>
        var db = client;
        var currentUser = null;
        var allTherapists = [];
        var selectedTherapist = null;

        async function checkAuth() {
            try {
                const {data: {session}} = await db.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return null;
                }
                const {data: profiles} = await db.from('profiles').select('*').eq('id', session.user.id);
                if (!profiles || profiles.length === 0) {
                    window.location.href = 'login.html';
                    return null;
                }
                const profile = profiles[0];
                if (profile.role && profile.role !== 'user') {
                    alert('Access denied. Users only.');
                    await db.auth.signOut();
                    window.location.href = 'index.html';
                    return null;
                }
                currentUser = profile;
                document.getElementById('userName').textContent = profile.full_name || profile.email;
                return profile;
            } catch (err) {
                console.error('Auth error:', err);
                window.location.href = 'login.html';
                return null;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'bookings') loadBookings();
            if (tabName === 'profile') loadProfile();
        }

        async function loadTherapists() {
            const result = await db.from('Therapists').select('*').eq('approval_status', 'approved').eq('Active', true);
            allTherapists = result.data || [];
            const specs = [...new Set(allTherapists.map(t => t.Specialization))];
            const filterSelect = document.getElementById('filterSpec');
            specs.forEach(spec => {
                const option = document.createElement('option');
                option.value = spec;
                option.textContent = spec;
                filterSelect.appendChild(option);
            });
            displayTherapists(allTherapists);
        }

        function displayTherapists(therapists) {
            const container = document.getElementById('therapistsList');
            if (!therapists || therapists.length === 0) {
                container.innerHTML = '<div class="no-data">No therapists available</div>';
                return;
            }
            let html = '';
            therapists.forEach(t => {
                html += '<div class="therapist-card"><div class="therapist-name">' + t.Name + '</div><div class="therapist-spec">üéØ ' + t.Specialization + '</div><div class="therapist-bio">' + (t.bio || 'Experienced professional ready to help you.') + '</div><div class="therapist-bio">üìû ' + (t.phone || 'N/A') + '</div><button class="btn btn-book" onclick=\'openBookingModal(' + JSON.stringify(t).replace(/'/g, "\\'") + ')\'>Book Session</button></div>';
            });
            container.innerHTML = html;
        }

        function filterTherapists() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const filterSpec = document.getElementById('filterSpec').value;
            let filtered = allTherapists.filter(t => {
                const matchName = t.Name.toLowerCase().includes(searchName);
                const matchSpec = !filterSpec || t.Specialization === filterSpec;
                return matchName && matchSpec;
            });
            displayTherapists(filtered);
        }

        function openBookingModal(therapist) {
            selectedTherapist = therapist;
            document.getElementById('modalTherapistName').value = therapist.Name;
            document.getElementById('bookingModal').classList.add('active');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sessionDate').min = today;
        }

        function closeModal() {
            document.getElementById('bookingModal').classList.remove('active');
            document.getElementById('sessionDate').value = '';
            document.getElementById('sessionTimeSlot').value = '';
            document.getElementById('sessionNotes').value = '';
            selectedTherapist = null;
        }

        function formatTime(time24) {
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return hour12 + ':' + minutes + ' ' + ampm;
        }

        async function confirmBooking() {
            const date = document.getElementById('sessionDate').value;
            const timeSlot = document.getElementById('sessionTimeSlot').value;
            const notes = document.getElementById('sessionNotes').value;
            
            if (!date || !timeSlot) {
                alert('Please select date and time slot');
                return;
            }
            
            const [startTime, endTime] = timeSlot.split('|');
            
            const {data: userBookings} = await db
                .from('Bookings')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('session_date', date)
                .neq('status', 'cancelled');
            
            if (userBookings && userBookings.length > 0) {
                for (let booking of userBookings) {
                    const existingStart = booking.start_time;
                    const existingEnd = booking.end_time;
                    
                    if (startTime < existingEnd && endTime > existingStart) {
                        const formattedStart = formatTime(existingStart);
                        const formattedEnd = formatTime(existingEnd);
                        alert('‚ö†Ô∏è Time Conflict!\n\nYou already have a booking from ' + formattedStart + ' to ' + formattedEnd + ' on this date.\n\nPlease choose a different time slot.');
                        return;
                    }
                }
            }
            
            const {data: therapistBookings} = await db
                .from('Bookings')
                .select('*')
                .eq('therapist_id', selectedTherapist.id)
                .eq('session_date', date)
                .neq('status', 'cancelled');
            
            if (therapistBookings && therapistBookings.length > 0) {
                for (let booking of therapistBookings) {
                    const existingStart = booking.start_time;
                    const existingEnd = booking.end_time;
                    
                    if (startTime < existingEnd && endTime > existingStart) {
                        const formattedStart = formatTime(existingStart);
                        const formattedEnd = formatTime(existingEnd);
                        alert('‚ö†Ô∏è Therapist Not Available!\n\nThis therapist is already booked from ' + formattedStart + ' to ' + formattedEnd + ' on this date.\n\nPlease choose a different time slot or therapist.');
                        return;
                    }
                }
            }
            
            const bookingData = {
                user_id: currentUser.id,
                therapist_id: selectedTherapist.id,
                session_date: date,
                start_time: startTime,
                end_time: endTime,
                status: 'pending'
            };
            if (notes) bookingData.notes = notes;
            
            const result = await db.from('Bookings').insert([bookingData]);
            if (result.error) {
                alert('‚ùå Booking Failed\n\n' + result.error.message + '\n\nPlease try again or contact support.');
                return;
            }
            
            alert('‚úÖ Booking Successful!\n\nYour session has been booked. The therapist will confirm shortly.');
            closeModal();
        }

        async function loadBookings() {
            const bookingsResult = await db.from('Bookings').select('*').eq('user_id', currentUser.id).order('session_date', { ascending: false });
            const container = document.getElementById('bookingsList');
            if (!bookingsResult.data || bookingsResult.data.length === 0) {
                container.innerHTML = '<div class="no-data">No bookings yet</div>';
                return;
            }
            const therapistsResult = await db.from('Therapists').select('id, Name, Specialization');
            const therapistMap = {};
            therapistsResult.data?.forEach(t => { therapistMap[t.id] = t; });
            let html = '<table class="bookings-table"><thead><tr><th>Therapist</th><th>Specialization</th><th>Date</th><th>Time</th><th>Status</th><th>Action</th></tr></thead><tbody>';
            bookingsResult.data.forEach(b => {
                const therapist = therapistMap[b.therapist_id];
                const canCancel = b.status === 'pending' || b.status === 'confirmed';
                const timeDisplay = formatTime(b.start_time) + ' - ' + formatTime(b.end_time || b.start_time);
                html += '<tr><td>' + (therapist?.Name || 'N/A') + '</td><td>' + (therapist?.Specialization || 'N/A') + '</td><td>' + new Date(b.session_date).toLocaleDateString() + '</td><td>' + timeDisplay + '</td><td><span class="status-badge status-' + b.status + '">' + b.status + '</span></td><td>' + (canCancel ? '<button class="btn btn-cancel" onclick="cancelBooking(\'' + b.id + '\')">Cancel</button>' : '-') + '</td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) return;
            const result = await db.from('Bookings').update({ status: 'cancelled' }).eq('id', bookingId);
            if (result.error) {
                alert('Error canceling booking: ' + result.error.message);
                return;
            }
            alert('Booking cancelled successfully');
            loadBookings();
        }

        function loadProfile() {
            document.getElementById('profileName').value = currentUser.full_name || '';
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profilePhone').value = currentUser.phone || '';
        }

        async function updateProfile() {
            const name = document.getElementById('profileName').value;
            const phone = document.getElementById('profilePhone').value;
            if (!name) {
                alert('Please enter your name');
                return;
            }
            const result = await db.from('profiles').update({ full_name: name, phone: phone }).eq('id', currentUser.id);
            if (result.error) {
                alert('Update failed: ' + result.error.message);
                return;
            }
            currentUser.full_name = name;
            currentUser.phone = phone;
            document.getElementById('userName').textContent = name;
            alert('Profile updated successfully!');
        }

        function doLogout() {
            client.auth.signOut().then(function() {
                window.location.href = 'index.html';
            });
        }

        async function init() {
            const user = await checkAuth();
            if (user) {
                await loadTherapists();
            }
        }

        init();
    </script>
</body>
</html>
